<!doctype html><html lang=en><head><title>Binding Quarkus and Kafka with the Service Binding Operator · Ioannis Canellos - My Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Ioannis Canellos"><meta name=description content="A quick walkthrough on how to bind Quarkus and Kafka using the Service Binding Operator"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Binding Quarkus and Kafka with the Service Binding Operator"><meta name=twitter:description content="A quick walkthrough on how to bind Quarkus and Kafka using the Service Binding Operator"><meta property="og:title" content="Binding Quarkus and Kafka with the Service Binding Operator"><meta property="og:description" content="A quick walkthrough on how to bind Quarkus and Kafka using the Service Binding Operator"><meta property="og:type" content="article"><meta property="og:url" content="https://iocanel.github.io/1/01/binding-quarkus-and-kafka-with-the-service-binding-operator/"><meta property="article:section" content="posts"><link rel=canonical href=https://iocanel.github.io/1/01/binding-quarkus-and-kafka-with-the-service-binding-operator/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.c4d7e93a158eda5a65b3df343745d2092a0a1e2170feeec909b8a89443903c6a.css integrity="sha256-xNfpOhWO2lpls980N0XSCSoKHiFw/u7JCbiolEOQPGo=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.78b5fe3864945faf5207fb8fe3ab2320d49c3365def0e88ac1df0ddadc54a03c.css integrity="sha256-eLX+OGSUX69SB/uP46sjINScM2Xe8OiKwd8N2txUoDw=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.105.0"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Ioannis Canellos - My Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>about</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://iocanel.github.io/1/01/binding-quarkus-and-kafka-with-the-service-binding-operator/>Binding Quarkus and Kafka with the Service Binding Operator</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=0001-01-01T00:00:00Z>January 1, 0001</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
7-minute read</span></div></div></header><div><h2 id=introduction>Introduction
<a class=heading-link href=#introduction><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p><a href=https://kubernetes.io>Kubernetes</a> is around for almost 7 years now and ever since the beggining there have been efforts to make consuming / binding to services simpler.
And while discovering the actual service is not so much of an issue (if you employ a set of conventions), getting the credentials etc is slightly trickier.</p><p>The <a href=https://svc-cat.io>Service Catalog</a> has been an effort that promised to simplify provisioning and binding to services, but it seems that it has lost its momentum. The lack
of uniformity between providers, the differences in how each service communicated the binding information and the fact that people tend to favor operators for provisioning services made it pretty hard to use in practice.</p><p>The <a href=https://github.com/redhat-developer/service-binding-operator>Service Binding Operator</a> is a more recent and modern initiative. It stays out of the way of service provisioning (leaving that to operators) and focuses on how to best communicate the binding information to the application.
An interesting part of the specification is the <a href=https://github.com/servicebinding/spec#workload-projection>workload projection</a>, which defines a directory structure that will be mounted to the application container when the binding happens in order to pass all the required binding information:</p><ul><li>type</li><li>uri</li><li>credentials</li></ul><p>Other parts of the specification are related to the `ServiceBinding` resource (which controls what services are bound to which application and how).</p><p><a href=https://quarkus.io/>Quarkus</a> already supports the <a href=https://github.com/servicebinding/spec#workload-projection>workload projection</a> part of the spec and recently received enhancments on the binding part, which is going to be the focus of this post.
In particular this post is going to discuss how the `ServiceBinding` can be automatically genenerated for the user and will walk you through the whole process from installing the needed operators to configuring and deploying the application.</p><p>For the shake of this post I am going to use <a href=https://kind.sigs.k8s.io/>kind</a> where I am going to install the <a href=https://github.com/redhat-developer/service-binding-operator>Service Binding Operator</a> and the <a href=https://strimzi.io/>Strimzi</a> operator for <a href=https://kafka.apache.org/>Kafka</a>.
Then, I am going to create a postgres cluster and finally I am going to use one of the <a href=https://quarkus.io/>Quarkus</a> quickstarts to bind to the provisioned postgres.</p><h3 id=start-a-new-kind-cluster>Start a new kind cluster
<a class=heading-link href=#start-a-new-kind-cluster><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>If you&rsquo;ve already created one, or don&rsquo;t use <a href=https://kind.sigs.k8s.io/>kind</a> at all, feel free to skip.</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>   kind create cluster
</span></span></code></pre></td></tr></table></div></div><h3 id=install-the-olm>Install the OLM
<a class=heading-link href=#install-the-olm><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Both operators that will be installed in this post, will be installed through the <a href=https://operatorhub.io>Operatorhub</a>.
So, the first step is to install the <a href=https://olm.operatorframework.io/>Operator Lifecycle Manager</a>.</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>     curl -sL https://github.com/operator-framework/operator-lifecycle-manager/releases/download/v0.19.1/install.sh <span style=color:#eceff4>|</span> bash -s v0.19.1
</span></span></code></pre></td></tr></table></div></div><h3 id=install-the-service-binding-operator>Install the Service Binding Operator
<a class=heading-link href=#install-the-service-binding-operator><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>   kubectl create -f https://operatorhub.io/install/service-binding-operator.yaml
</span></span></code></pre></td></tr></table></div></div><p>To verify the installation execute the following command.</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>     kubectl get csv -n operators
</span></span></code></pre></td></tr></table></div></div><p>When the `phase` of the <a href=https://github.com/redhat-developer/service-binding-operator>Service Binding Operator</a> is `Succeeded` you may proceed to the next step.</p><h3 id=install-the-postgres-crunchy-operator>Install the Postgres Crunchy Operator
<a class=heading-link href=#install-the-postgres-crunchy-operator><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>   kubectl create -f https://operatorhub.io/install/postgresql.yaml
</span></span></code></pre></td></tr></table></div></div><p>As above to verify the installation execute:</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>     kubectl get csv -n operators
</span></span></code></pre></td></tr></table></div></div><p>When the `phase` of the operator is `Succeeded` you may proceed to the next step.</p><h3 id=create-a-postgres-cluster>Create a Postgres cluster
<a class=heading-link href=#create-a-postgres-cluster><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>We shall create a new namespace, where we will install our cluster and application</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>     kubectl create ns demo
</span></span><span style=display:flex><span>     kubectl config set-context --current --namespace<span style=color:#81a1c1>=</span>demo
</span></span></code></pre></td></tr></table></div></div><p>To create the cluster we need to apply the following custom resource:</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">39
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#81a1c1>apiVersion</span><span style=color:#eceff4>:</span> postgres-operator.crunchydata.com/v1beta1
</span></span><span style=display:flex><span><span style=color:#81a1c1>kind</span><span style=color:#eceff4>:</span> PostgresCluster
</span></span><span style=display:flex><span><span style=color:#81a1c1>metadata</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>  <span style=color:#81a1c1>name</span><span style=color:#eceff4>:</span> pg-cluster
</span></span><span style=display:flex><span>  <span style=color:#81a1c1>namespace</span><span style=color:#eceff4>:</span> demo
</span></span><span style=display:flex><span><span style=color:#81a1c1>spec</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>  <span style=color:#81a1c1>image</span><span style=color:#eceff4>:</span> registry.developers.crunchydata.com/crunchydata/crunchy-postgres-ha:centos8-13.4-0
</span></span><span style=display:flex><span>  <span style=color:#81a1c1>postgresVersion</span><span style=color:#eceff4>:</span> <span style=color:#b48ead>13</span>
</span></span><span style=display:flex><span>  <span style=color:#81a1c1>instances</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>    - <span style=color:#81a1c1>name</span><span style=color:#eceff4>:</span> instance1
</span></span><span style=display:flex><span>      <span style=color:#81a1c1>dataVolumeClaimSpec</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1>accessModes</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>        - <span style=color:#a3be8c>&#34;ReadWriteOnce&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1>resources</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>          <span style=color:#81a1c1>requests</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1>storage</span><span style=color:#eceff4>:</span> 1Gi
</span></span><span style=display:flex><span>  <span style=color:#81a1c1>backups</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1>pgbackrest</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>      <span style=color:#81a1c1>image</span><span style=color:#eceff4>:</span> registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:centos8-2.33-2
</span></span><span style=display:flex><span>      <span style=color:#81a1c1>repos</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>      - <span style=color:#81a1c1>name</span><span style=color:#eceff4>:</span> repo1
</span></span><span style=display:flex><span>        <span style=color:#81a1c1>volume</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>          <span style=color:#81a1c1>volumeClaimSpec</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1>accessModes</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>            - <span style=color:#a3be8c>&#34;ReadWriteOnce&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1>resources</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>              <span style=color:#81a1c1>requests</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>                <span style=color:#81a1c1>storage</span><span style=color:#eceff4>:</span> 1Gi
</span></span><span style=display:flex><span>      - <span style=color:#81a1c1>name</span><span style=color:#eceff4>:</span> repo2
</span></span><span style=display:flex><span>        <span style=color:#81a1c1>volume</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>          <span style=color:#81a1c1>volumeClaimSpec</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1>accessModes</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>            - <span style=color:#a3be8c>&#34;ReadWriteOnce&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1>resources</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>              <span style=color:#81a1c1>requests</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>                <span style=color:#81a1c1>storage</span><span style=color:#eceff4>:</span> 1Gi
</span></span><span style=display:flex><span>  <span style=color:#81a1c1>proxy</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1>pgBouncer</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>      <span style=color:#81a1c1>image</span><span style=color:#eceff4>:</span> registry.developers.crunchydata.com/crunchydata/crunchy-pgbouncer:centos8-1.15-2
</span></span></code></pre></td></tr></table></div></div><p>This resource has been borrowed from <a href=https://redhat-developer.github.io/service-binding-operator/userguide/getting-started/quick-start.html>Service Binding Operator Quickstart</a>, which is definitely something worth looking into (if you haven&rsquo;t already).</p><p>Let&rsquo;s save that file under `pg-cluster.yml` and apply it using `kubectl`</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>   kubectl apply -f ~/pg-cluster.yml
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s check the pods to verify the installation:</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>   kubectl get pods -n demo
</span></span></code></pre></td></tr></table></div></div><h3 id=create-a-quarkus-application-that-will-bind-to-postgres>Create a Quarkus application that will bind to Postgres
<a class=heading-link href=#create-a-quarkus-application-that-will-bind-to-postgres><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>Instead of creating an application from scratch, I am going to use one of the <a href=https://github.com/quarkusio/quarkus-quickstarts.git>Quarkus Quickstarts</a>.</p><h4 id=grab-a-quickstart-that-uses-postgres>Grab a quickstart that uses postgres
<a class=heading-link href=#grab-a-quickstart-that-uses-postgres><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>The quickstart repository is quite large, So if you don&rsquo;t want to <a href=#clone-the-repo>clone the repo</a> you can just perform a <a href=#sparse-checkout>sparse checkout</a>.
Both ways are demonstrated below and in both cases the quickstart from `2.3.1.Final` tag should be available under `~/quickstarts/hibernate-orm-panache-quickstart`.</p><ul><li><p>clone the repo</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>       git clone --depth <span style=color:#b48ead>1</span> --branch 2.3.1.Final git@github.com:quarkusio/quarkus-quickstarts.git ~/quickstarts
</span></span><span style=display:flex><span>       <span style=color:#81a1c1>cd</span> ~/quickstarts/hibernate-orm-panache-quickstart
</span></span></code></pre></td></tr></table></div></div></li></ul><ul><li><p>sparse checkout</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>       mkdir ~/quickstarts
</span></span><span style=display:flex><span>       <span style=color:#81a1c1>cd</span> ~/quickstarts
</span></span><span style=display:flex><span>       git init
</span></span><span style=display:flex><span>       git config core.sparseCheckout <span style=color:#81a1c1>true</span>
</span></span><span style=display:flex><span>       git remote add origin git@github.com:quarkusio/quarkus-quickstarts.git
</span></span><span style=display:flex><span>       <span style=color:#81a1c1>echo</span> <span style=color:#a3be8c>&#34;hibernate-orm-panache-quickstart/&#34;</span> &gt; .git/info/sparse-checkout
</span></span><span style=display:flex><span>       git pull origin 2.3.1.Final
</span></span><span style=display:flex><span>       <span style=color:#81a1c1>cd</span> hibernate-orm-panache-quickstart
</span></span></code></pre></td></tr></table></div></div></li></ul><h4 id=add-the-kubernetes-and-service-binding-extensions>Add the Kubernetes and Service Binding extensions
<a class=heading-link href=#add-the-kubernetes-and-service-binding-extensions><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>      quarkus ext add -B kubernetes
</span></span><span style=display:flex><span>      quarkus ext add -B kubernetes-service-binding
</span></span><span style=display:flex><span>      quarkus ext add -B container-image-docker
</span></span></code></pre></td></tr></table></div></div><h4 id=bind-to-the-target-postgres-cluster>Bind to the target Postgres cluster
<a class=heading-link href=#bind-to-the-target-postgres-cluster><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>In order to bind the postgres service to our application we need to either provide a `ServiceBidning` resource or have it generated.
To have the binding generated for us we need to provide the service coordinates:</p><ul><li><p>apiVersion: `postgres-operator.crunchydata.com/v1beta1`</p></li><li><p>kind: `PostgresCluster`</p></li><li><p>name: `pg-cluster`</p><p>prefixed with `quarkus.kubernetes-service-binding.services.&lt;id>.` as shown below:</p></li></ul><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>      <span style=color:#81a1c1>echo</span> <span style=color:#a3be8c>&#34;quarkus.kubernetes-service-binding.services.my-db.api-version=postgres-operator.crunchydata.com/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>      quarkus.kubernetes-service-binding.services.my-db.kind=PostgresCluster
</span></span></span><span style=display:flex><span><span style=color:#a3be8c>      quarkus.kubernetes-service-binding.services.my-db.name=pg-cluster&#34;</span> &gt;&gt; ~/quickstarts/hibernate-orm-panache-quickstart/src/main/resources/application.properties
</span></span></code></pre></td></tr></table></div></div><p><strong>Note</strong>: The &lt;id> can be anything at this point. It&rsquo;s only used for correlating the service coordinates.</p><h4 id=switch-the-latest-quarkus-version>Switch the latest Quarkus version
<a class=heading-link href=#switch-the-latest-quarkus-version><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>Generation of the Service Binding resource is not available in `2.3.1.Final` so we are going to switch to a snapshot version.
This means that you need to checkout and build quarkus from latest `main`.
This post assumes you have already done so and skips directly to the next step, which is switching to the snapshot version:</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>      sed -i <span style=color:#a3be8c>&#34;s|2.3.1.Final|999-SNAPSHOT|g&#34;</span> pom.xml
</span></span></code></pre></td></tr></table></div></div><h4 id=prepare-for-deployment>Prepare for deployment
<a class=heading-link href=#prepare-for-deployment><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>To deploy, we need to perform a container image build, load the image to our cluster (remember we are using <a href=https://kind.sigs.k8s.io/>kind</a>), generate the resource and perform the deployment.</p><ul><li><p>Build the container image</p><p>To build the container image, you can use:</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>       mvn clean install -Dquarkus.container-image.build<span style=color:#81a1c1>=</span><span style=color:#81a1c1>true</span> -DskipTests
</span></span></code></pre></td></tr></table></div></div><p>This assumes that you have docker up and running.</p></li></ul><ul><li><p>Load the docker image to the cluster</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>     kind load docker-image iocanel/hibernate-orm-panache-quickstart:1.0.0-SNAPSHOT
</span></span></code></pre></td></tr></table></div></div><ul><li><p>Loading the image on minikube</p><p>If you are using <a href=https://minikube.sigs.k8s.io/docs/start/>minikube</a> instead, then execute:</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>     <span style=color:#81a1c1>eval</span> <span style=color:#81a1c1;font-weight:700>$(</span>minikube docker-env<span style=color:#81a1c1;font-weight:700>)</span>
</span></span></code></pre></td></tr></table></div></div><p>and re-build the image.</p><p>When using tools like <a href=https://kind.sigs.k8s.io/>kind</a> or <a href=https://minikube.sigs.k8s.io/docs/start/>minikube</a>, it is generally a good idea to change the image pull policy to `IfNotPresent` to avoid uneeded pulls, since most of the time the image will be loaded from the local docker daemon, as shown above.
To set the image pull policy:</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>      <span style=color:#81a1c1>echo</span> <span style=color:#a3be8c>&#34;quarkus.kubernetes.image-pull-policy=IfNotPresent&#34;</span> &gt;&gt; ~/quickstarts/hibernate-orm-panache-quickstart/src/main/resources/application.properties
</span></span></code></pre></td></tr></table></div></div></li></ul></li></ul><ul><li><p>Deploy the application</p><p>The next step will generate the deployment manifest, including the `ServiceBinding` and will apply them on kubernetes.</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>       mvn clean install -Dquarkus.kubernetes.deploy<span style=color:#81a1c1>=</span><span style=color:#81a1c1>true</span> -DskipTests
</span></span></code></pre></td></tr></table></div></div></li></ul><ul><li><p>Verify the installation</p><div class=highlight><div style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#6c6f74">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>       kubectl port-forward service/hibernate-orm-panache-quickstart 8080:80
</span></span></code></pre></td></tr></table></div></div><p>Open your browser on <a href=http://localhost:8080>http://localhost:8080</a> and enjoy!</p></li></ul><h2 id=thoughts-and-future-steps>Thoughts and future steps
<a class=heading-link href=#thoughts-and-future-steps><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>I am really excited with the progress on the Service binding front. Thinks are looking great and can look even better.
Some potential improvements I can see coming in the near future, is reducing the amount of needed configuration, with the use of smart conventions (e.g. assuming that custom resource name is the same as the database name unless explicitly specified) and a reasonable set of defaults (e.g. assuming that for postgres the default operator is <a href=https://github.com/CrunchyData/postgres-operator>CrunchyData operator</a>).
This could even allow us to bind to services with zero config, without really sacrificing in flexibility and customizability!</p><p>I hope I could get you even half as excited as I am!</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2019 -
2022
Ioannis Canellos
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.236049395dc3682fb2719640872958e12f1f24067bb09c327b233e6290c7edac.js integrity="sha256-I2BJOV3DaC+ycZZAhylY4S8fJAZ7sJwyeyM+YpDH7aw="></script></body></html>